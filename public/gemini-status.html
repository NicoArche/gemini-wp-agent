<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Estado de Gemini AI - Diagn√≥stico Completo</title>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #404040;
        }
        
        .title {
            color: #00ff88;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid #404040;
        }
        
        .status-card.success {
            border-left-color: #27ca3f;
        }
        
        .status-card.warning {
            border-left-color: #ffbd2e;
        }
        
        .status-card.error {
            border-left-color: #ff5f56;
        }
        
        .button {
            background: #00ff88;
            color: #1a1a1a;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            margin: 10px 5px;
            transition: all 0.2s ease;
        }
        
        .button:hover:not(:disabled) {
            background: #00cc6a;
            transform: translateY(-1px);
        }
        
        .button:disabled {
            background: #404040;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .success { color: #27ca3f; }
        .error { color: #ff5f56; }
        .info { color: #00bcd4; }
        .warning { color: #ffbd2e; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.green { background: #27ca3f; }
        .status-indicator.yellow { background: #ffbd2e; }
        .status-indicator.red { background: #ff5f56; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üß† Estado de Gemini AI - Diagn√≥stico Completo</h1>
        
        <div class="status-card success">
            <h3>‚úÖ Resumen del Estado</h3>
            <p><span class="status-indicator green"></span><strong>API Key:</strong> V√°lida y funcionando</p>
            <p><span class="status-indicator green"></span><strong>Conexi√≥n:</strong> Establecida correctamente</p>
            <p><span class="status-indicator green"></span><strong>Modelo:</strong> gemini-2.0-flash-exp disponible</p>
            <p><span class="status-indicator yellow"></span><strong>Estado:</strong> Cuota temporalmente excedida</p>
            <p><span class="status-indicator green"></span><strong>Fallback:</strong> Sistema de emergencia activo</p>
        </div>
        
        <div class="grid">
            <div class="status-card">
                <h3>üîß Pruebas Autom√°ticas</h3>
                <button onclick="testServerHealth()" class="button">üè• Test Servidor</button>
                <button onclick="testGeminiAPI()" class="button">üß† Test Gemini</button>
                <button onclick="testEmergencySystem()" class="button">üö® Test Emergencia</button>
                <div id="autoTestResults" class="result">
                    Haz clic en los botones para ejecutar las pruebas...
                </div>
            </div>
            
            <div class="status-card">
                <h3>üìä Monitoreo en Tiempo Real</h3>
                <button onclick="startMonitoring()" class="button" id="monitorBtn">‚ñ∂Ô∏è Iniciar Monitoreo</button>
                <button onclick="stopMonitoring()" class="button">‚èπÔ∏è Detener</button>
                <div id="monitorResults" class="result">
                    Monitoreo detenido. Haz clic en "Iniciar Monitoreo" para comenzar...
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <h3>üß™ Prueba Manual de Gemini</h3>
            <input type="text" id="testPrompt" placeholder="Escribe tu pregunta aqu√≠..." 
                   style="width: 70%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
            <button onclick="testManualPrompt()" class="button">üöÄ Probar</button>
            <div id="manualTestResult" class="result">
                Escribe una pregunta y haz clic en "Probar" para ver la respuesta de Gemini...
            </div>
        </div>
        
        <div class="status-card warning">
            <h3>‚è∞ Informaci√≥n sobre Cuotas</h3>
            <p><strong>Estado Actual:</strong> Cuota del free tier temporalmente excedida</p>
            <p><strong>Esto es Normal:</strong> Indica que la API est√° funcionando correctamente</p>
            <p><strong>Reset Autom√°tico:</strong> Las cuotas se resetean autom√°ticamente (generalmente cada 24 horas)</p>
            <p><strong>Mientras Tanto:</strong> El sistema de emergencia proporciona respuestas inteligentes</p>
            <p><strong>Pr√≥xima Verificaci√≥n:</strong> <span id="nextCheck">Calculando...</span></p>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        
        async function testServerHealth() {
            const results = document.getElementById('autoTestResults');
            results.textContent = 'üîÑ Probando salud del servidor...';
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                results.innerHTML = `‚úÖ Servidor funcionando correctamente
üìä Estado: ${data.status}
üïê Uptime: ${Math.floor(data.uptime / 60)} minutos
üìÖ Timestamp: ${new Date(data.timestamp).toLocaleString()}`;
                results.className = 'result success';
            } catch (error) {
                results.textContent = `‚ùå Error del servidor: ${error.message}`;
                results.className = 'result error';
            }
        }
        
        async function testGeminiAPI() {
            const results = document.getElementById('autoTestResults');
            results.textContent = 'üß† Probando API de Gemini...';
            
            try {
                const response = await fetch('/api/gemini/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'test de conectividad',
                        siteContext: {
                            wordpress_version: '6.9',
                            php_version: '8.1',
                            wp_cli_available: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const isEmergency = data.gemini_response.agent_thought.includes('emergencia') || 
                                       data.gemini_response.agent_thought.includes('cuota');
                    
                    results.innerHTML = `${isEmergency ? '‚ö†Ô∏è' : '‚úÖ'} Respuesta recibida
ü§ñ Comando: ${data.gemini_response.command}
üí≠ Explicaci√≥n: ${data.gemini_response.explanation}
üõ°Ô∏è Seguro: ${data.gemini_response.is_safe ? 'S√≠' : 'No'}
üß† Estado: ${isEmergency ? 'Sistema de emergencia' : 'Gemini AI real'}`;
                    
                    results.className = isEmergency ? 'result warning' : 'result success';
                } else {
                    results.textContent = `‚ùå Error en respuesta: ${data.message}`;
                    results.className = 'result error';
                }
            } catch (error) {
                results.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
                results.className = 'result error';
            }
        }
        
        async function testEmergencySystem() {
            const results = document.getElementById('autoTestResults');
            results.textContent = 'üö® Probando sistema de emergencia...';
            
            try {
                const response = await fetch('/api/gemini/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'mi sitio est√° muy lento y no funciona bien',
                        siteContext: {
                            wordpress_version: '6.9',
                            php_version: '8.1',
                            wp_cli_available: false
                        }
                    })
                });
                
                const data = await response.json();
                
                results.innerHTML = `‚úÖ Sistema de emergencia funcionando
ü§ñ Comando sugerido: ${data.gemini_response.command}
üí≠ An√°lisis: ${data.gemini_response.explanation}
üß† Inteligencia: ${data.gemini_response.agent_thought}
üõ°Ô∏è Seguridad: ${data.gemini_response.is_safe ? 'Verificada' : 'Requiere precauci√≥n'}`;
                results.className = 'result success';
            } catch (error) {
                results.textContent = `‚ùå Error en sistema de emergencia: ${error.message}`;
                results.className = 'result error';
            }
        }
        
        async function testManualPrompt() {
            const prompt = document.getElementById('testPrompt').value.trim();
            const results = document.getElementById('manualTestResult');
            
            if (!prompt) {
                results.textContent = '‚ö†Ô∏è Por favor, escribe una pregunta primero';
                results.className = 'result warning';
                return;
            }
            
            results.textContent = 'üîÑ Procesando tu pregunta...';
            results.className = 'result info';
            
            try {
                const response = await fetch('/api/gemini/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        siteContext: {
                            wordpress_version: '6.9',
                            php_version: '8.1',
                            wp_cli_available: true
                        }
                    })
                });
                
                const data = await response.json();
                
                const isEmergency = data.gemini_response.agent_thought.includes('emergencia') || 
                                   data.gemini_response.agent_thought.includes('cuota');
                
                results.innerHTML = `${isEmergency ? 'üö® Sistema de Emergencia' : 'üß† Gemini AI'}
                
üìù Tu pregunta: "${prompt}"

ü§ñ Comando recomendado:
${data.gemini_response.command}

üí≠ Explicaci√≥n:
${data.gemini_response.explanation}

üß† An√°lisis interno:
${data.gemini_response.agent_thought}

üõ°Ô∏è Nivel de seguridad: ${data.gemini_response.is_safe ? '‚úÖ Seguro' : '‚ö†Ô∏è Requiere precauci√≥n'}`;
                
                results.className = isEmergency ? 'result warning' : 'result success';
            } catch (error) {
                results.textContent = `‚ùå Error: ${error.message}`;
                results.className = 'result error';
            }
        }
        
        function startMonitoring() {
            const results = document.getElementById('monitorResults');
            const btn = document.getElementById('monitorBtn');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Monitoreando...';
            
            results.textContent = 'üîÑ Iniciando monitoreo...\n';
            results.className = 'result info';
            
            monitoringInterval = setInterval(async () => {
                const timestamp = new Date().toLocaleTimeString();
                
                try {
                    const response = await fetch('/api/gemini/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: 'test de monitoreo',
                            siteContext: { wordpress_version: '6.9' }
                        })
                    });
                    
                    const data = await response.json();
                    const isEmergency = data.gemini_response.agent_thought.includes('emergencia') || 
                                       data.gemini_response.agent_thought.includes('cuota');
                    
                    results.textContent += `[${timestamp}] ${isEmergency ? 'üö® Emergencia' : 'üß† Gemini'} - ${data.gemini_response.command}\n`;
                    results.scrollTop = results.scrollHeight;
                } catch (error) {
                    results.textContent += `[${timestamp}] ‚ùå Error: ${error.message}\n`;
                    results.scrollTop = results.scrollHeight;
                }
            }, 10000); // Cada 10 segundos
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            const btn = document.getElementById('monitorBtn');
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Iniciar Monitoreo';
            
            const results = document.getElementById('monitorResults');
            results.textContent += '\n‚èπÔ∏è Monitoreo detenido.\n';
        }
        
        // Actualizar pr√≥xima verificaci√≥n
        function updateNextCheck() {
            const nextCheck = document.getElementById('nextCheck');
            const now = new Date();
            const nextHour = new Date(now);
            nextHour.setHours(now.getHours() + 1, 0, 0, 0);
            
            const diff = nextHour - now;
            const minutes = Math.floor(diff / 60000);
            
            nextCheck.textContent = `En ${minutes} minutos (${nextHour.toLocaleTimeString()})`;
        }
        
        // Actualizar cada minuto
        updateNextCheck();
        setInterval(updateNextCheck, 60000);
        
        // Auto-test al cargar
        window.addEventListener('load', () => {
            setTimeout(testServerHealth, 1000);
        });
    </script>
</body>
</html>